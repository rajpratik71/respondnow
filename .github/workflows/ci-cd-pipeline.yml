name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual trigger
    inputs:
      deploy:
        description: 'Deploy after tests pass'
        required: false
        default: 'false'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend

jobs:
  # ===========================================
  # Backend Jobs
  # ===========================================
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run backend tests
        working-directory: ./server
        run: mvn clean test jacoco:report -B
      
      - name: Upload backend coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./server/target/site/jacoco/jacoco.xml
          flags: backend
  
  backend-build:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: backend-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build backend
        working-directory: ./server
        run: mvn clean package -DskipTests -B
      
      - name: Upload backend artifact
        uses: actions/upload-artifact@v3
        with:
          name: backend-jar
          path: server/target/*.jar
  
  # ===========================================
  # Frontend Jobs
  # ===========================================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'yarn'
          cache-dependency-path: portal/yarn.lock
      
      - name: Install dependencies
        working-directory: ./portal
        run: yarn install
      
      - name: Run frontend tests
        working-directory: ./portal
        run: yarn test --ci --coverage --maxWorkers=2
      
      - name: Upload frontend coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./portal/coverage/lcov.info
          flags: frontend
  
  frontend-build:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: frontend-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'yarn'
          cache-dependency-path: portal/yarn.lock
      
      - name: Install dependencies
        working-directory: ./portal
        run: yarn install
      
      - name: Build frontend
        working-directory: ./portal
        run: yarn build
      
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: portal/build/
  
  # ===========================================
  # Integration Tests
  # ===========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    
    services:
      mongodb:
        image: mongo:5.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run integration tests
        working-directory: ./server
        env:
          SPRING_DATA_MONGODB_URI: mongodb://test:test@localhost:27017/test?authSource=admin
        run: mvn verify -B
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: server/target/failsafe-reports/
  
  # ===========================================
  # Coverage Report
  # ===========================================
  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download coverage reports
        uses: actions/download-artifact@v3
      
      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./server/target/site/jacoco/jacoco.xml,./portal/coverage/lcov.info
          flags: combined
          fail_ci_if_error: false
      
      - name: Generate coverage summary
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- See JaCoCo report in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- See LCOV report in artifacts" >> $GITHUB_STEP_SUMMARY
  
  # ===========================================
  # Status Check
  # ===========================================
  status-check:
    name: CI/CD Status Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, backend-build, frontend-build]
    if: always()
    
    steps:
      - name: Check status
        run: |
          echo "## CI/CD Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Tests: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Build: ${{ needs.backend-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Build: ${{ needs.frontend-build.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.backend-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.backend-build.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-build.result }}" == "failure" ]]; then
            echo "❌ Pipeline failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ Pipeline succeeded!" >> $GITHUB_STEP_SUMMARY
          fi
