import React, { useState, useEffect } from 'react';
import { useUsers, useDeleteUserMutation, User } from '@services/server';
import { CreateUserDialog } from './CreateUserDialog';
import { EditUserDialog } from './EditUserDialog';

export const UserList: React.FC = () => {
  const { data: users, isLoading, error } = useUsers();
  const deleteUser = useDeleteUserMutation();
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editUser, setEditUser] = useState<User | null>(null);

  useEffect(() => {
    console.log('UserList rendered - isLoading:', isLoading, 'error:', error, 'users:', users);
  }, [isLoading, error, users]);

  const handleDelete = (userId: string, username: string) => {
    if (window.confirm(`Are you sure you want to delete user "${username}"?`)) {
      deleteUser.mutate(userId);
    }
  };

  if (isLoading) {
    return <div className="loading">Loading users...</div>;
  }

  if (error) {
    return <div className="error">Error loading users</div>;
  }

  return (
    <div className="user-management">
      <div className="header">
        <h2>User Management</h2>
        <button className="btn-primary" onClick={() => setCreateDialogOpen(true)}>
          + Create User
        </button>
      </div>

      <div className="table-container">
        <table className="users-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Name</th>
              <th>Email</th>
              <th>Status</th>
              <th>Roles</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {users?.map((user) => (
              <tr key={user.id}>
                <td>{user.username}</td>
                <td>{user.fullName || `${user.firstName} ${user.lastName}`}</td>
                <td>{user.email}</td>
                <td>
                  <span className={`status-badge status-${user.status.toLowerCase()}`}>
                    {user.status}
                  </span>
                </td>
                <td>
                  <div className="roles">
                    {user.roleNames?.length > 0
                      ? user.roleNames.map((role) => (
                          <span key={role} className="role-badge">
                            {role}
                          </span>
                        ))
                      : <span className="text-muted">No roles</span>
                    }
                  </div>
                </td>
                <td>
                  <div className="actions">
                    <button
                      className="btn-secondary btn-sm"
                      onClick={() => setEditUser(user)}
                    >
                      Edit
                    </button>
                    <button
                      className="btn-danger btn-sm"
                      onClick={() => handleDelete(user.id, user.username)}
                    >
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {users?.length === 0 && (
          <div className="empty-state">
            <p>No users found. Create your first user to get started.</p>
          </div>
        )}
      </div>

      {createDialogOpen && (
        <CreateUserDialog
          isOpen={createDialogOpen}
          onClose={() => setCreateDialogOpen(false)}
        />
      )}

      {editUser && (
        <EditUserDialog
          user={editUser}
          isOpen={!!editUser}
          onClose={() => setEditUser(null)}
        />
      )}
    </div>
  );
};
